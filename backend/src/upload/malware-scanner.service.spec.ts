import { Test, TestingModule } from '@nestjs/testing';
import { MalwareScannerService } from './malware-scanner.service';
import { ConfigService } from '@nestjs/config';

describe('MalwareScannerService', () => {
    let service: MalwareScannerService;
    let configService: ConfigService;

    const mockConfigService = {
        get: jest.fn((key: string, defaultValue?: any) => {
            if (key === 'MALWARE_SCAN_ENABLED') {
                return true; // Enable for testing
            }
            return defaultValue;
        }),
    };

    beforeEach(async () => {
        const module: TestingModule = await Test.createTestingModule({
            providers: [
                MalwareScannerService,
                { provide: ConfigService, useValue: mockConfigService },
            ],
        }).compile();

        service = module.get<MalwareScannerService>(MalwareScannerService);
        configService = module.get<ConfigService>(ConfigService);

        await service.onModuleInit();
    });

    it('should be defined', () => {
        expect(service).toBeDefined();
    });

    describe('EICAR Test Virus Detection', () => {
        it('should detect EICAR test virus', async () => {
            // EICAR standard test string
            const eicarString = 'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*';
            const buffer = Buffer.from(eicarString);

            const result = await service.scanBuffer(buffer);

            expect(result.isInfected).toBe(true);
            expect(result.viruses).toContain('EICAR-Test-File');
        });

        it('should detect EICAR in larger buffer', async () => {
            const eicarString = 'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*';
            const content = 'Some random content before\n' + eicarString + '\nSome content after';
            const buffer = Buffer.from(content);

            const result = await service.scanBuffer(buffer);

            expect(result.isInfected).toBe(true);
            expect(result.viruses.length).toBeGreaterThan(0);
        });

        it('should pass clean buffer', async () => {
            const cleanBuffer = Buffer.from('This is a clean file with no malware');

            const result = await service.scanBuffer(cleanBuffer);

            expect(result.isInfected).toBe(false);
            expect(result.viruses).toEqual([]);
        });

        it('should pass clean image buffer', async () => {
            // JPEG signature
            const jpegBuffer = Buffer.from([
                0xFF, 0xD8, 0xFF, 0xE0,
                0x00, 0x10, 0x4A, 0x46,
                0x49, 0x46, 0x00, 0x01,
            ]);

            const result = await service.scanBuffer(jpegBuffer);

            expect(result.isInfected).toBe(false);
            expect(result.viruses).toEqual([]);
        });
    });

    describe('Service Status', () => {
        it('should return enabled status', () => {
            const status = service.getStatus();

            expect(status.enabled).toBe(true);
            expect(status.available).toBe(true);
            expect(status.ready).toBe(true);
        });

        it('should indicate availability', () => {
            const available = service.isAvailable();

            expect(available).toBe(true);
        });
    });

    describe('Disabled Scanner', () => {
        let disabledService: MalwareScannerService;

        beforeEach(async () => {
            const mockDisabledConfig = {
                get: jest.fn((key: string, defaultValue?: any) => {
                    if (key === 'MALWARE_SCAN_ENABLED') {
                        return false; // Disabled
                    }
                    return defaultValue;
                }),
            };

            const module: TestingModule = await Test.createTestingModule({
                providers: [
                    MalwareScannerService,
                    { provide: ConfigService, useValue: mockDisabledConfig },
                ],
            }).compile();

            disabledService = module.get<MalwareScannerService>(MalwareScannerService);
            await disabledService.onModuleInit();
        });

        it('should skip scanning when disabled', async () => {
            const eicarString = 'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*';
            const buffer = Buffer.from(eicarString);

            const result = await disabledService.scanBuffer(buffer);

            // Should not detect even EICAR when disabled
            expect(result.isInfected).toBe(false);
            expect(result.viruses).toEqual([]);
        });

        it('should report disabled status', () => {
            const status = disabledService.getStatus();

            expect(status.enabled).toBe(false);
            expect(status.ready).toBe(false);
        });
    });

    describe('Edge Cases', () => {
        it('should handle empty buffer', async () => {
            const emptyBuffer = Buffer.alloc(0);

            const result = await service.scanBuffer(emptyBuffer);

            expect(result.isInfected).toBe(false);
        });

        it('should handle very large buffer', async () => {
            const largeBuffer = Buffer.alloc(10 * 1024 * 1024); // 10MB
            largeBuffer.fill('A');

            const result = await service.scanBuffer(largeBuffer);

            expect(result.isInfected).toBe(false);
        });

        it('should handle binary data', async () => {
            const binaryBuffer = Buffer.from([
                0x00, 0x01, 0x02, 0x03, 0xFF, 0xFE, 0xFD, 0xFC,
            ]);

            const result = await service.scanBuffer(binaryBuffer);

            expect(result.isInfected).toBe(false);
        });
    });

    describe('Error Handling', () => {
        it('should handle scan errors gracefully', async () => {
            // Test with null buffer (should throw)
            await expect(service.scanBuffer(null as any)).rejects.toThrow();
        });
    });
});
