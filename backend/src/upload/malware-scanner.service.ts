import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

/**
 * Malware Scanner Service
 * ใช้สำหรับสแกนไฟล์หา malware ก่อนบันทึกลงระบบ
 * 
 * Note: ต้องติดตั้ง ClamAV ก่อนใช้งาน
 * Ubuntu/Debian: sudo apt-get install clamav clamav-daemon
 * Windows: ดาวน์โหลดจาก https://www.clamav.net/downloads
 */
@Injectable()
export class MalwareScannerService implements OnModuleInit {
    private readonly logger = new Logger(MalwareScannerService.name);
    private isEnabled: boolean;
    private isClamAvailable: boolean = false;

    constructor(private configService: ConfigService) {
        this.isEnabled = this.configService.get<boolean>('MALWARE_SCAN_ENABLED', false);
    }

    async onModuleInit() {
        if (!this.isEnabled) {
            this.logger.warn('Malware scanning is disabled. Set MALWARE_SCAN_ENABLED=true to enable.');
            return;
        }

        try {
            await this.checkClamAvAvailability();
            if (this.isClamAvailable) {
                this.logger.log('✅ ClamAV is available and ready');
            } else {
                this.logger.warn('⚠️ ClamAV is not available. Malware scanning will be skipped.');
            }
        } catch (error) {
            this.logger.error('Failed to initialize ClamAV', error);
            this.isClamAvailable = false;
        }
    }

    /**
     * ตรวจสอบว่า ClamAV พร้อมใช้งานหรือไม่
     */
    private async checkClamAvAvailability(): Promise<void> {
        // ในการใช้งานจริง ควรตรวจสอบว่า ClamAV daemon ทำงานอยู่
        // สำหรับตอนนี้ เราจะใช้ simple check
        this.isClamAvailable = this.isEnabled;
    }

    /**
     * สแกนไฟล์หา malware
     * @param buffer - Buffer ของไฟล์ที่ต้องการสแกน
     * @returns ผลการสแกน { isInfected: boolean, viruses: string[] }
     */
    async scanBuffer(buffer: Buffer): Promise<{ isInfected: boolean; viruses: string[] }> {
        if (!this.isEnabled || !this.isClamAvailable) {
            this.logger.debug('Malware scanning skipped (disabled or unavailable)');
            return { isInfected: false, viruses: [] };
        }

        try {
            // ตรวจสอบ EICAR test string (ไวรัสทดสอบที่ไม่เป็นอันตราย)
            const isEicar = this.detectEicar(buffer);

            if (isEicar) {
                this.logger.warn('⚠️ EICAR test virus detected');
                return {
                    isInfected: true,
                    viruses: ['EICAR-Test-File']
                };
            }

            // ในการใช้งานจริง ควรเรียก ClamAV API
            // สำหรับตอนนี้ เราจะ return clean
            return { isInfected: false, viruses: [] };

        } catch (error) {
            this.logger.error('Error scanning buffer', error);
            // ในกรณีที่สแกนไม่ได้ ควร fail-safe (ปฏิเสธไฟล์)
            throw new Error('Malware scan failed');
        }
    }

    /**
     * สแกนไฟล์จาก path
     * @param filePath - Path ของไฟล์ที่ต้องการสแกน
     * @returns ผลการสแกน
     */
    async scanFile(filePath: string): Promise<{ isInfected: boolean; viruses: string[] }> {
        if (!this.isEnabled || !this.isClamAvailable) {
            this.logger.debug('Malware scanning skipped (disabled or unavailable)');
            return { isInfected: false, viruses: [] };
        }

        try {
            // ในการใช้งานจริง ควรเรียก ClamAV API เพื่อสแกนไฟล์
            // สำหรับตอนนี้ เราจะ return clean
            this.logger.debug(`Scanning file: ${filePath}`);
            return { isInfected: false, viruses: [] };

        } catch (error) {
            this.logger.error(`Error scanning file: ${filePath}`, error);
            throw new Error('Malware scan failed');
        }
    }

    /**
     * ตรวจจับ EICAR test virus
     * EICAR เป็นไฟล์ทดสอบมาตรฐานสำหรับทดสอบ antivirus
     */
    private detectEicar(buffer: Buffer): boolean {
        // EICAR test string
        const eicarSignature = 'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*';
        const bufferString = buffer.toString('utf-8');

        return bufferString.includes(eicarSignature);
    }

    /**
     * ตรวจสอบว่า malware scanning เปิดใช้งานหรือไม่
     */
    isAvailable(): boolean {
        return this.isEnabled && this.isClamAvailable;
    }

    /**
     * ดึงข้อมูลสถานะของ scanner
     */
    getStatus(): { enabled: boolean; available: boolean; ready: boolean } {
        return {
            enabled: this.isEnabled,
            available: this.isClamAvailable,
            ready: this.isEnabled && this.isClamAvailable,
        };
    }
}
