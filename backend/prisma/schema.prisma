generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String           @id @default(uuid())
  username           String           @unique
  email              String           @unique
  password           String
  fullName           String           @map("full_name")
  firstName          String?          @map("first_name")
  lastName           String?          @map("last_name")
  department         String?
  phone              String?
  profileImage       String?          @map("profile_image")
  role               Role             @default(FIELD_OFFICER)
  isActive           Boolean          @default(true) @map("is_active")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  activityLogs       ActivityLog[]
  assignedIncidents  Incident[]       @relation("AssignedIncidents")
  createdIncidents   Incident[]       @relation("CreatedBy")
  reviewedIncidents  Incident[]       @relation("ReviewedIncidents")
  reports            Report[]         @relation("ReportAuthor")
  reviewedReports    Report[]         @relation("ReviewedBy")
  submittedResponses SurveyResponse[] @relation("SubmittedResponses")
  createdSurveys     Survey[]         @relation("CreatedSurveys")
  assignedTasks      Task[]           @relation("AssignedTo")
  createdTasks       Task[]           @relation("TaskCreator")
  userNotifications  UserNotification[]

  @@map("users")
}

model Village {
  id             String     @id @default(uuid())
  villageNo      Int        @unique @map("village_no")
  name           String
  alternateNames String[]   @map("alternate_names")
  centerPoint    Json?      @map("center_point")
  boundary       Json?
  households     Int?
  population     Int?
  area           Decimal?   @db.Decimal(10, 2)
  description    String?
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  incidents      Incident[]
  surveys        Survey[]
  tasks          Task[]

  @@index([villageNo])
  @@map("villages")
}

model Incident {
  id           String         @id @default(uuid())
  title        String
  description  String?
  status       IncidentStatus @default(PENDING)
  priority     Priority       @default(MEDIUM)
  location     Json
  address      String?
  images       String[]       @default([])
  villageId    String?        @map("village_id")
  disasterType DisasterType
  reportedAt   DateTime       @default(now()) @map("reported_at")
  resolvedAt   DateTime?      @map("resolved_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  assignedToId String?        @map("assigned_to_id")
  assignedAt   DateTime?      @map("assigned_at")
  reviewNotes  String?        @map("review_notes")
  reviewedAt   DateTime?      @map("reviewed_at")
  reviewedById String?        @map("reviewed_by_id")
  createdById  String         @map("created_by_id")
  assignedTo   User?          @relation("AssignedIncidents", fields: [assignedToId], references: [id])
  createdBy    User           @relation("CreatedBy", fields: [createdById], references: [id])
  reviewedBy   User?          @relation("ReviewedIncidents", fields: [reviewedById], references: [id])
  village      Village?       @relation(fields: [villageId], references: [id])
  reports      Report[]
  surveys      Survey[]
  tasks        Task[]

  @@index([status])
  @@index([priority])
  @@index([disasterType])
  @@index([villageId])
  @@index([createdAt])
  @@map("incidents")
}

model Task {
  id             String       @id @default(uuid())
  title          String
  description    String?
  status         TaskStatus   @default(PENDING)
  priority       TaskPriority @default(MEDIUM)
  dueDate        DateTime?    @map("due_date")
  completedAt    DateTime?    @map("completed_at")
  surveyedAt     DateTime?    @map("surveyed_at")
  surveyLocation String?      @map("survey_location")
  surveyArea     String?      @map("survey_area")
  surveyNotes    String?      @map("survey_notes")
  surveyPhotos   String[]     @default([]) @map("survey_photos")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  incidentId     String       @map("incident_id")
  assignedToId   String?      @map("assigned_to_id")
  createdById    String       @map("created_by_id")
  villageId      String?      @map("village_id")
  assignedTo     User?        @relation("AssignedTo", fields: [assignedToId], references: [id])
  createdBy      User         @relation("TaskCreator", fields: [createdById], references: [id])
  incident       Incident     @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  village        Village?     @relation(fields: [villageId], references: [id])

  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdById])
  @@index([incidentId])
  @@index([villageId])
  @@map("tasks")
}

model SurveyTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  fields      Json
  isActive    Boolean  @default(true)
  surveys     Survey[]

  @@map("survey_templates")
}

model Survey {
  id          String           @id @default(uuid())
  incidentId  String?          @map("incident_id")
  villageId   String?          @map("village_id")
  templateId  String           @map("template_id")
  status      SurveyStatus     @default(PENDING)
  completedAt DateTime?        @map("completed_at")
  polygon     Json?
  createdById String           @map("created_by_id")
  responses   SurveyResponse[]
  createdBy   User             @relation("CreatedSurveys", fields: [createdById], references: [id])
  incident    Incident?        @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  template    SurveyTemplate   @relation(fields: [templateId], references: [id])
  village     Village?         @relation(fields: [villageId], references: [id])

  @@index([incidentId])
  @@index([villageId])
  @@index([templateId])
  @@index([createdById])
  @@map("surveys")
}

model SurveyResponse {
  id            String   @id @default(uuid())
  surveyId      String   @map("survey_id")
  data          Json
  submittedAt   DateTime @default(now()) @map("submitted_at")
  submittedById String   @map("submitted_by_id")
  submittedBy   User     @relation("SubmittedResponses", fields: [submittedById], references: [id])
  survey        Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([submittedById])
  @@map("survey_responses")
}

model Report {
  id                  String       @id @default(uuid())
  type                ReportType   @default(INCIDENT)
  status              ReportStatus @default(DRAFT)
  title               String
  summary             String?
  content             Json?
  details             Json?
  totalDamageEstimate Decimal?     @map("total_damage_estimate") @db.Decimal(15, 2)
  affectedHouseholds  Int?         @map("affected_households")
  affectedPersons     Int?         @map("affected_persons")
  aiAnalysis          Json?        @map("ai_analysis")
  photoUrls           String[]     @map("photo_urls")
  templateId          String?      @map("template_id")
  periodStart         DateTime?    @map("period_start")
  periodEnd           DateTime?    @map("period_end")
  metadata            Json?
  pdfUrl              String?      @map("pdf_url")
  pdfGeneratedAt      DateTime?    @map("pdf_generated_at")
  reviewNotes         String?      @map("review_notes")
  reviewedAt          DateTime?    @map("reviewed_at")
  submittedAt         DateTime?    @map("submitted_at")
  approvedAt          DateTime?    @map("approved_at")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  taskIds             String[]     @default([]) @map("task_ids")
  surveyIds           String[]     @default([]) @map("survey_ids")
  incidentId          String?      @map("incident_id")
  authorId            String       @map("author_id")
  reviewedById        String?      @map("reviewed_by_id")
  author              User         @relation("ReportAuthor", fields: [authorId], references: [id])
  incident            Incident?    @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  reviewedBy          User?        @relation("ReviewedBy", fields: [reviewedById], references: [id])

  @@index([type])
  @@index([status])
  @@index([authorId])
  @@index([incidentId])
  @@index([periodStart])
  @@index([createdAt])
  @@map("reports")
}

model ReportTemplate {
  id          String     @id @default(uuid())
  name        String
  type        ReportType
  description String?
  structure   Json
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@index([type])
  @@index([isActive])
  @@map("report_templates")
}

model ActivityLog {
  id        String   @id @default(uuid())
  action    String
  entity    String?
  entityId  String?  @map("entity_id")
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  username   String
  action     String
  targetType String?  @map("target_type")
  targetId   String?  @map("target_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([targetType])
  @@index([createdAt])
  @@map("audit_logs")
}

model GeoBoundary {
  id         String   @id @default(uuid())
  name       String
  type       String
  geojson    Json
  properties Json?
  villageId  String?  @map("village_id")
  uploadedBy String   @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([type])
  @@index([villageId])
  @@map("geo_boundaries")
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

enum Role {
  FIELD_OFFICER
  SUPERVISOR
  EXECUTIVE
  ADMIN
  DEVELOPER
}

enum IncidentStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  SURVEYED
  COMPLETED
  CANCELLED
}

enum ReportStatus {
  DRAFT
  GENERATING
  READY
  ERROR
  SUBMITTED
  UNDER_REVIEW
  REVISION_REQUIRED
  APPROVED
  REJECTED
}

enum ReportType {
  INCIDENT
  INCIDENT_SUMMARY
  TASK
  TASK_PROGRESS
  SURVEY
  SURVEY_RESULTS
  MONTHLY
  MONTHLY_SUMMARY
  CUSTOM
}

enum DisasterType {
  FLOOD
  LANDSLIDE
  FIRE
  STORM
  EARTHQUAKE
  OTHER
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SurveyStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Settings {
  id String @id @default(uuid())

  // General (4)
  systemName         String  @default("Guardian Route") @map("system_name")
  timezone           String  @default("Asia/Bangkok")
  maintenanceMode    Boolean @default(false) @map("maintenance_mode")
  maintenanceMessage String? @map("maintenance_message")

  // Security (4)
  enforce2FA        Boolean @default(false) @map("enforce_2fa")
  minPasswordLength Int     @default(8) @map("min_password_length")
  sessionTimeout    Int     @default(30) @map("session_timeout")
  ipAllowlist       String? @map("ip_allowlist")

  // Map & GIS (6)
  defaultLat          Float   @default(19.9167) @map("default_lat")
  defaultLng          Float   @default(99.8833) @map("default_lng")
  defaultZoom         Int     @default(13) @map("default_zoom")
  defaultBaseLayer    String  @default("street") @map("default_base_layer")
  customTileServer    String? @map("custom_tile_server")
  enableWeatherRadar  Boolean @default(false) @map("enable_weather_radar")

  // Notifications (5)
  emailOnNewIncident Boolean @default(true) @map("email_on_new_incident")
  smsOnHighSeverity  Boolean @default(false) @map("sms_on_high_severity")
  dailyEmailSummary  Boolean @default(true) @map("daily_email_summary")
  enableLineNotify   Boolean @default(false) @map("enable_line_notify")
  lineNotifyToken    String? @map("line_notify_token")

  // API (4)
  weatherApiKey        String? @map("weather_api_key")
  smsGatewayApiKey     String? @map("sms_gateway_api_key")
  maxRequestsPerMinute Int     @default(60) @map("max_requests_per_minute")
  blockDuration        Int     @default(300) @map("block_duration")

  // Data (2)
  dataRetentionDays Int    @default(365) @map("data_retention_days")
  backupFrequency   String @default("daily") @map("backup_frequency")

  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("settings")
}

model Notification {
  id                String               @id @default(uuid())
  title             String
  message           String
  type              NotificationType
  priority          NotificationPriority @default(NORMAL)
  data              Json?
  relatedEntityType String?              @map("related_entity_type")
  relatedEntityId   String?              @map("related_entity_id")
  createdAt         DateTime             @default(now()) @map("created_at")

  userNotifications UserNotification[]

  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@map("notifications")
}

model UserNotification {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  notificationId String        @map("notification_id")
  isRead         Boolean       @default(false) @map("is_read")
  readAt         DateTime?     @map("read_at")
  createdAt      DateTime      @default(now()) @map("created_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
  @@index([userId])
  @@index([notificationId])
  @@index([isRead])
  @@map("user_notifications")
}

enum NotificationType {
  INCIDENT_CREATED
  INCIDENT_ASSIGNED
  INCIDENT_UPDATED
  INCIDENT_RESOLVED
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMPLETED
  REPORT_SUBMITTED
  REPORT_APPROVED
  REPORT_REJECTED
  SYSTEM_ALERT
  SYSTEM_MAINTENANCE
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
